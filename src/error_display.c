/*****************************************************************************

error_display.c

Error Display/Formatting Utilities

*****************************************************************************/

/*----------------------------------------------------------------------------
Includes
----------------------------------------------------------------------------*/

#include <windows.h>
#include <stdio.h>
#include <tchar.h>

/*----------------------------------------------------------------------------
Macros
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
Types and Structures
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
Memory Constants
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
Module Variables
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
Module Prototypes
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
Implementation
----------------------------------------------------------------------------*/

/*==========================================================================*/
void print_error(                   /* print error information to stderr    */
    DWORD               error,      /* error number to display              */
    LPCTSTR             message     /* user message to display              */
) {

    /*------------------------------------------------------
    Local Variables
    ------------------------------------------------------*/
    LPVOID              message_buffer;
                                    /* pointer to error message string      */

    /*------------------------------------------------------
    Format the error message for display.
    ------------------------------------------------------*/
    FormatMessage(
        ( FORMAT_MESSAGE_ALLOCATE_BUFFER
        | FORMAT_MESSAGE_FROM_SYSTEM
        | FORMAT_MESSAGE_IGNORE_INSERTS ),
        NULL,
        error,
        MAKELANGID( LANG_NEUTRAL, SUBLANG_DEFAULT ),
        ( LPTSTR ) &message_buffer,
        0,
        NULL
    );

    /*------------------------------------------------------
    Check for a user-specified message.
    ------------------------------------------------------*/
    if( message != NULL ) {

        /*--------------------------------------------------
        Send the formatted error message to stderr.
        --------------------------------------------------*/
        fprintf(
            stderr,
            _T( "%s: %s" ),
            message,
            ( LPTSTR ) message_buffer
        );

    }

    /*------------------------------------------------------
    No user-specified message.
    ------------------------------------------------------*/
    else {

        /*--------------------------------------------------
        Send the formatted error message to stderr.
        --------------------------------------------------*/
        fprintf( stderr, ( LPTSTR ) message_buffer );

    }

    /*------------------------------------------------------
    Free the allocated message buffer.
    ------------------------------------------------------*/
    LocalFree( message_buffer );

}

